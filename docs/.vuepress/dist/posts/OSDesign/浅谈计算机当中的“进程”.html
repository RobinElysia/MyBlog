<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <meta name="keywords" content="计算机进程内容详解、进程、进程内存、资源描述符映射、操作系统对象"><meta name="description" content="计算机进程内容详解"><meta name="author" content="RobinElysia"><link rel="icon" href="./assets/img/Rlogo.png"><title>计算机当中的“进程” | RSD's Blog</title>
    <link rel="preload" href="/assets/style-D_AzHp4n.css" as="style"><link rel="stylesheet" href="/assets/style-D_AzHp4n.css">
    <link rel="modulepreload" href="/assets/app-BPzQcCmO.js"><link rel="modulepreload" href="/assets/浅谈计算机当中的“进程”.html-BbBH2ApJ.js">
    <link rel="prefetch" href="/assets/AboutUs.html-BVi7gtbl.js" as="script"><link rel="prefetch" href="/assets/Link.html-SBxBUB1e.js" as="script"><link rel="prefetch" href="/assets/index.html-DliEA0bs.js" as="script"><link rel="prefetch" href="/assets/AnalyticsAreAFullStackProblem.html-CwlxNzyH.js" as="script"><link rel="prefetch" href="/assets/furthermore.html-B5Ei-VA1.js" as="script"><link rel="prefetch" href="/assets/TalkAboutPresent.html-BoUGN-Nd.js" as="script"><link rel="prefetch" href="/assets/三尺之上的灵魂.html-C5YTKNiG.js" as="script"><link rel="prefetch" href="/assets/道德的讲座.html-BvkYrQmn.js" as="script"><link rel="prefetch" href="/assets/BodyAndSoul.html-Cm4v2gvj.js" as="script"><link rel="prefetch" href="/assets/ExistentialismAndAbsurdPhilosophy.html-CNJJSkvq.js" as="script"><link rel="prefetch" href="/assets/No-fighting.html-GoH5duZ1.js" as="script"><link rel="prefetch" href="/assets/缄默者.html-CrpkgVdu.js" as="script"><link rel="prefetch" href="/assets/深度学习环境搭建.html-OPnUGGh1.js" as="script"><link rel="prefetch" href="/assets/cs229-boosting.html-DeHYovVD.js" as="script"><link rel="prefetch" href="/assets/cs229-gaussian_processes.html-DaJ2KG_5.js" as="script"><link rel="prefetch" href="/assets/cs229-hoeffding.html-Bis1haAK.js" as="script"><link rel="prefetch" href="/assets/cs229-loss-functions.html-BjFLGaNJ.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-BP.html-rHRAvZxq.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-cvxopt.html-DPKEjQYJ.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-cvxopt2.html-BoCE4EuX.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-deep_learning.html-I8GI3Qv8.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-dt.html-BdHdMCYF.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-ensemble.html-Bh2jxqG7.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-gaussians.html-DsaY0KFq.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-hmm.html-D6aV-4G6.js" as="script"><link rel="prefetch" href="/assets/cs229-notes-more_on_gaussians.html-BZ404Mxr.js" as="script"><link rel="prefetch" href="/assets/cs229-notes1.html-B-2vEWFv.js" as="script"><link rel="prefetch" href="/assets/cs229-notes10.html-EmSbqyW9.js" as="script"><link rel="prefetch" href="/assets/cs229-notes11.html-DmNv_t2W.js" as="script"><link rel="prefetch" href="/assets/cs229-notes12.html-DsQp5jjc.js" as="script"><link rel="prefetch" href="/assets/cs229-notes13.html-CNqtHOXW.js" as="script"><link rel="prefetch" href="/assets/cs229-notes2.html-BGBrsaR_.js" as="script"><link rel="prefetch" href="/assets/cs229-notes3.html-DqdA9zpv.js" as="script"><link rel="prefetch" href="/assets/cs229-notes4.html-C8i37658.js" as="script"><link rel="prefetch" href="/assets/cs229-notes5.html-Bj0_S1AA.js" as="script"><link rel="prefetch" href="/assets/cs229-notes6.html-Dh-g3575.js" as="script"><link rel="prefetch" href="/assets/cs229-notes7a.html-ruriONjM.js" as="script"><link rel="prefetch" href="/assets/cs229-notes7b.html-nH2JBf7m.js" as="script"><link rel="prefetch" href="/assets/cs229-notes8.html-C-v9NmT6.js" as="script"><link rel="prefetch" href="/assets/cs229-notes9.html-B-Gc_dxN.js" as="script"><link rel="prefetch" href="/assets/cs229-representer-function.html-FGZnawNf.js" as="script"><link rel="prefetch" href="/assets/CS229ReadingGuide.html-BJnkERU5.js" as="script"><link rel="prefetch" href="/assets/BaseCommand.html-CGS6YYDm.js" as="script"><link rel="prefetch" href="/assets/DockerElasticSearch.html-BIS2CI3J.js" as="script"><link rel="prefetch" href="/assets/DockerNginx.html-CrpKqCnH.js" as="script"><link rel="prefetch" href="/assets/dockerPrincess.html-CKejyaiP.js" as="script"><link rel="prefetch" href="/assets/Dockertomcat.html-ucakblfr.js" as="script"><link rel="prefetch" href="/assets/installDocker.html-Bxd7fnwc.js" as="script"><link rel="prefetch" href="/assets/OtherCommand.html-Dfbf_Bb0.js" as="script"><link rel="prefetch" href="/assets/what's Docker.html-CZrAtODb.js" as="script"><link rel="prefetch" href="/assets/MachineLearning.html-Bq2FBvyp.js" as="script"><link rel="prefetch" href="/assets/Terminal、ProcGroupAndUnixShell.html-ks37pin5.js" as="script"><link rel="prefetch" href="/assets/TheObjectOfTheOperatingSystem.html-DO2DZK7K.js" as="script"><link rel="prefetch" href="/assets/浅谈计算机设计哲学—“贯穿计算机硬件、操作系统与程序的万能状态机”.html-Cd_4EDE_.js" as="script"><link rel="prefetch" href="/assets/25-10PaperBlogRead.html-BbcHuM5G.js" as="script"><link rel="prefetch" href="/assets/25-11PaperBlogRead.html-CF_dyqEd.js" as="script"><link rel="prefetch" href="/assets/feihua.html-Ckfu76B_.js" as="script"><link rel="prefetch" href="/assets/judge.html-DCkbscJB.js" as="script"><link rel="prefetch" href="/assets/NothinIsAMorePractical.html-X6Hc3Ufy.js" as="script"><link rel="prefetch" href="/assets/OneATrulySimpleIntroductionToDatabases.html-PbB-Ry2B.js" as="script"><link rel="prefetch" href="/assets/QuestionArticle.html-vmf5yAyF.js" as="script"><link rel="prefetch" href="/assets/ThinkingAboutMachineLearing.html-UL-GMUb6.js" as="script"><link rel="prefetch" href="/assets/TowATrulySimpleIntroductionToDatabases.html-Dn9F6T-q.js" as="script"><link rel="prefetch" href="/assets/入坑计算机指南.html-dDiQbNBv.js" as="script"><link rel="prefetch" href="/assets/handle.html-CsG5xRi5.js" as="script"><link rel="prefetch" href="/assets/404.html-DBiFIfWu.js" as="script"><link rel="prefetch" href="/assets/index.html-DU8Ey0Yr.js" as="script"><link rel="prefetch" href="/assets/index.html-Ck_zpJl4.js" as="script"><link rel="prefetch" href="/assets/index.html-DrE_lXZL.js" as="script"><link rel="prefetch" href="/assets/index.html-t4B1fOpv.js" as="script"><link rel="prefetch" href="/assets/index.html-C42My2OD.js" as="script"><link rel="prefetch" href="/assets/index.html-Cggvs7IZ.js" as="script"><link rel="prefetch" href="/assets/index.html-4lOBMoXR.js" as="script"><link rel="prefetch" href="/assets/index.html-B5vwYGk3.js" as="script"><link rel="prefetch" href="/assets/index.html-CIYnPHhn.js" as="script"><link rel="prefetch" href="/assets/index.html-BEwc72xj.js" as="script"><link rel="prefetch" href="/assets/index.html-CdJluCDg.js" as="script"><link rel="prefetch" href="/assets/index.html-ysYs7bqk.js" as="script"><link rel="prefetch" href="/assets/index.html-CqG5ZeiQ.js" as="script"><link rel="prefetch" href="/assets/index.html-DknmUDRO.js" as="script"><link rel="prefetch" href="/assets/index.html-B2iSmi2T.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/./assets/img/Rlogo.png" alt="RSD&#39;s Blog"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">RSD&#39;s Blog</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="RSD"><!--[--><!--[--><!--]--><!--]-->RSD<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/article/" aria-label="文章"><!--[--><!--[--><!--]--><!--]-->文章<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/category/" aria-label="分类"><!--[--><!--[--><!--]--><!--]-->分类<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/tag/" aria-label="标签"><!--[--><!--[--><!--]--><!--]-->标签<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--><!--]-->时间线<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="RSD"><!--[--><!--[--><!--]--><!--]-->RSD<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/article/" aria-label="文章"><!--[--><!--[--><!--]--><!--]-->文章<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/category/" aria-label="分类"><!--[--><!--[--><!--]--><!--]-->分类<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/tag/" aria-label="标签"><!--[--><!--[--><!--]--><!--]-->标签<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--><!--]-->时间线<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">计算机当中的“进程” <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><link rel="stylesheet" href="/css/font-style.css"><h1 id="计算机当中的-进程" tabindex="-1"><a class="header-anchor" href="#计算机当中的-进程"><span>计算机当中的“进程”</span></a></h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p> 在<a class="route-link" href="/posts/OSDesign/%E6%B5%85%E8%B0%88%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6%E2%80%94%E2%80%9C%E8%B4%AF%E7%A9%BF%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A1%AC%E4%BB%B6%E3%80%81%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E4%B8%87%E8%83%BD%E7%8A%B6%E6%80%81%E6%9C%BA%E2%80%9D.html">上一篇文档</a>中，我们重点强调了<!---->。这句话几乎抽象的描述了计算机整个设计的大体，但是我们不应该仅仅止步于此。所以我想在操作系统上<s>大展拳脚</s>，但总归操作系统的复杂程度不亚于航空母舰，能够将大型操作系统深入浅出，是一个极具挑战的任务...当然我们没有必要仔细到头发丝，能大体描述就能<s>击败全国99%的玩家</s>。<!----></p><h2 id="上篇文章遗留-zygote安卓世界里的受精卵进程" tabindex="-1"><a class="header-anchor" href="#上篇文章遗留-zygote安卓世界里的受精卵进程"><span>上篇文章遗留：Zygote安卓世界里的受精卵进程</span></a></h2><p> “Zygote”，中文叫受精卵（<s>真的就是生物那个词</s>），是Android系统中一个非常核心的进程。在Android系统启动完成后，Zygote 会首先启动，并在系统运行期间常驻内存。它的职责简单粗暴却非常关键：<strong>创建其他进程的模板。</strong></p><p> 你可以这么理解：Zygote 就像一个“克隆工厂”，每次你打开一个App，Zygote就 fork 出一个新的子进程，复制自己的进程上下文（代码段、数据段、堆、栈、寄存器……）并稍作修改。这样，启动速度比重新加载所有资源要快得多。<strong>这种机制我们叫 Copy-on-Write <!---->，节省了大量内存。</strong></p><p> 但是我们刚刚提到了 fork，我们得讲讲进程里到底“复制了什么？”</p><h2 id="fork后的进程-内存、寄存器和你看不见的世界" tabindex="-1"><a class="header-anchor" href="#fork后的进程-内存、寄存器和你看不见的世界"><span>fork后的进程：内存、寄存器和你看不见的世界</span></a></h2><p> 当我们写下 <code>int* p = main(); printf(&quot;%p&quot;, p);</code> 时，很多人第一反应是：<strong>咦？main还能返回指针？</strong> 实际上，虽然 <code>main()</code> 是有定义规范的（返回 <code>int</code>），但我们更关心的是：<strong><code>p</code> 的地址指向哪一块内存？</strong></p><p> 这就进入了我们今天的主题：<strong>进程的地址空间</strong>。</p><p> 每一个进程都有一整块属于它自己的<strong>虚拟地址空间</strong>。在 Linux 上，可以在gdb调试使用 <code>info proc mappings</code> 或者 <code>cat /proc/$PID/maps</code>，就可以窥见一个进程的全貌。我们也可以写个 GDB 插件（<s>AI来一个？</s>）来自动将每个进程的映射信息输出成 Markdown 报表，非常适合做调试文档。</p><p><img src="/assets/img/sysProcess/proc-maps.png" style="zoom:50%;display:block;margin:0 auto;" alt="maps"></p><p> 当我们去查看这些信息时，可以看到在这些地址空间里，有些段很有趣，比如：</p><ul><li><code>vvar</code>（只读）：保存系统调用相关的信息，这是干嘛的？AI一下 <ul><li>哦，原来是防止进程频繁syscall的。比如 <code>gettimeofday()</code> 这样的函数可以不再陷入内核，而是从 <code>vvar</code> 区读取值</li></ul></li><li><code>vdso</code>（可执行）：也是系统相关的辅助代码，性能优化神器</li></ul><p> 我们发现，原来是这是一种系统优化。但是，这是该进程的内存，其他不在 <code>/proc/$PID/maps</code> 中的内存段？你敢访问试试，<!----> 直接见面。所以，这里必须强调一个观点：<strong>系统调用（syscall）并不总是切换到内核态！并且有些内存段是不可访问或者修改的！</strong></p><p> 但是话又说回来，在上个文章中我们仅仅简单说了进程的复制和复位，程序在Linux中到底是怎么复制然后初始化的？我们目前还是未知...</p><h2 id="execve之后-一个进程的原初状态" tabindex="-1"><a class="header-anchor" href="#execve之后-一个进程的原初状态"><span>execve之后：一个进程的原初状态</span></a></h2><p> 当我们用 <code>execve()</code> 启动一个程序时，我们知道它其实不是“创建”，而是“重建”：它<strong>替换</strong>了当前进程的地址空间，重新加载二进制文件。这个过程仅涉及父子进程层面，不涉及操作系统层面（文件资源分配、各种ID和内核对象）</p><p> 这个加载过程由操作系统配合二进制格式（比如 ELF）完成，细节可参考 System V ABI：</p><ul><li>把程序的 <code>.text</code> 段放入代码区域</li><li><code>.data</code> 和 <code>.bss</code> 放入数据段</li><li>加载器准备栈，并放置 <code>argc</code>, <code>argv</code>, <code>envp</code></li><li>设置寄存器初始值，比如 <code>RIP</code> 指向程序入口地址 <code>_start</code> （main函数的底层）</li></ul><p> 这一切都在瞬间完成，但每一次 App 启动、命令执行，都是一次 “进程重生”。</p><p> 进程在execve后会直接分配一段内存。但是，内存总有一天可能会被用光，这时候怎么办？</p><h2 id="进程的房子不够大怎么办-内存扩展和mmap的魔法" tabindex="-1"><a class="header-anchor" href="#进程的房子不够大怎么办-内存扩展和mmap的魔法"><span>进程的房子不够大怎么办？内存扩展和mmap的魔法</span></a></h2><p> 我们有必要先科普一下知识。首先，<em><strong>现代操作系统为每个进程分配一块虚拟地址空间，在 32 位系统上通常是 4GB (0x00000000 - 0xFFFFFFFF)，而在 64 位下那就是银河级别的大小</strong></em>，其次虚拟地址空间主要包括：</p><ol><li><strong>代码段 (Text Segment)</strong>：程序的机器码</li><li><strong>数据段 (Data Segment)</strong>：初始化的全局变量</li><li><strong>BSS段</strong>：未初始化的全局变量</li><li><strong>堆（Heap）</strong>：动态分配，如 <code>malloc</code>（之后再说）</li><li><strong>栈（Stack）</strong>：函数调用用的</li><li><strong>内存映射区域（Memory Mapped Region）</strong>：文件、共享内存（这一部分重点关注）</li></ol><p> 当你发现内存不够用时，可以使用 <code>mmap</code> 显式映射更多内存。它的参数结构如下：</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c"><pre><code><span class="line"><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p> <a href="/file/mmap.txt">man mmap</a></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment"># 手册命令</span></span>
<span class="line"><span class="token function">man</span> mmap</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>addr</code>: 映射起始地址，NULL 为自动分配</li><li><code>length</code>: 映射长度</li><li><code>prot</code>: <code>PROT_READ</code>、<code>PROT_WRITE</code>、<code>PROT_EXEC</code> 权限划分</li><li><code>flags</code>: <code>MAP_SHARED</code> 或 <code>MAP_PRIVATE</code> 共享内存和私有内存</li><li><code>fd</code>: 要映射的文件描述符（<code>-1</code> 表示匿名内存）</li><li><code>offset</code>: 文件偏移，可以理解为一个文件的索引cur</li></ul><p> 当我们看到这些参数时，诶，fd映射？好熟悉我好像在哪里见过？fd的存在可以实现把一个文件资源映射到内存中，不需要再open、raed… <strong>那我是不是可以把整个磁盘，映射到内存空间里！</strong> 好吧，答案是可以的，并且这个过程是惰性的。操作系统分配巨大的内存时运行非常快——是操作系统采用了“懒分配”机制，<strong>只有访问才真正触发物理内存分配</strong>，否则什么也不干（fast and slow path设计，这个之后的文章里也会讲）。</p><p> 但是问题又来了，假如这个时候我们的A进程在复制复位后得B，当B宕掉，A是怎么感知的？答案是子进程如果出现异常退出，CPU会捕获异常交给操作系统，操作系统发送信号通知父进程，<s>你的儿子没了</s>。</p><p> 还有一些题外话，Linux还提供了一些可以用来查看指定进程的任何地址 report memory map of a process（man pmap）：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">pmap PID</span>
<span class="line"><span class="token comment"># 就可以把一个进程的所有地址空间打印出来</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p> <a href="/file/pmap.txt">man pmap</a></p><p> 它是怎么实现的？其实是依赖 /proc 文件系统，可以 ls /proc/PID/ 查看，其中存在一个特殊的文件：ls /proc/PID/maps，打印出来：cat /proc/PID/maps，就是刚刚的pmap，只不过对其进行了删减（下文查看的是11进程）。我们也可以使用 strace 来检验</p><p> <a href="/file/pmapTest.txt">pmap 11</a>、<a href="/file/mapsTest.txt">cat /proc/11/maps</a></p><p><img src="/assets/img/sysProcess/mapsAndpmap.png" style="zoom:50%;display:block;margin:0 auto;" alt="mapsAndpmap"></p><p> 在程序中，我们还有 munmap（解除内存映射）、mprotect（修改内存区域的保护权限）这两个系统调用，我们可以使用man查看相关手册</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">man</span> munmap</span>
<span class="line"><span class="token function">man</span> mprotect</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-C line-numbers-mode" data-highlighter="prismjs" data-ext="C"><pre><code><span class="line">void *ptr = mmap(NULL, 4096, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);</span>
<span class="line">mprotect(ptr, 4096, PROT_READ); // 禁止写入</span>
<span class="line"></span>
<span class="line">void *ptr = mmap(NULL, 4096, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);</span>
<span class="line">munmap(ptr, 4096); // 释放内存</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p> 之后我们会想，我们既然可以在程序内操作内存，那么我们是不是也可以在其他进程中操作进程内存？YES！</p><h2 id="黑入别人的内存空间-进程劫持的魔法" tabindex="-1"><a class="header-anchor" href="#黑入别人的内存空间-进程劫持的魔法"><span>黑入别人的内存空间：进程劫持的魔法</span></a></h2><p>接下来，聊聊更具“黑客气息”的部分：<strong>我们能不能修改别的进程的内存？</strong></p><p>答案是：<strong>当然可以，比如当年的物理修改器“金手指”<strong>和</strong>我们现在可能会用到的gdb调试</strong>。</p><h3 id="look-up-table-lut-金手指的灵魂" tabindex="-1"><a class="header-anchor" href="#look-up-table-lut-金手指的灵魂"><span>Look-up Table(LUT)：金手指的灵魂</span></a></h3><p><img src="/assets/img/sysProcess/game-genie.webp" style="zoom:50%;display:block;margin:0 auto;" alt="game-genie"></p><p> 早年间打游戏用的金手指，本质上就是在进程运行时修改内存值。它的大致原理很简单：</p><ol><li>游戏 ROM 加载到某个内存区域</li><li>指针访问内存时，会从某地址返回一个值</li><li>如果我们能劫持这个“返回值”，就能实现修改</li><li>这就是 Lookup Table：中间插一层伪 ROM</li></ol><p> 如果存在一个可以将返回值V1—变化为—V2的“中间件”（实际上也替换了卡带的固件，直接识别的是这个中间件），那么就可以实现物理意义上的数据修改。但问题是，有时候事与愿违，很多值（比如金币数量）可能是<strong>动态地址</strong>。怎么办？</p><p><img src="/assets/img/sysProcess/knight.webp" style="zoom:50%;display:block;margin:0 auto;" alt="alterMem"></p><p>那就用状态机思想，多次观察某个值的变化过程，从而“猜测”它的地址——这也是手机上<strong>GG修改器</strong>等修改游戏数据的原理（<s>知识串联了有没有</s>）。</p><h3 id="入侵工具箱-你手上有这些武器" tabindex="-1"><a class="header-anchor" href="#入侵工具箱-你手上有这些武器"><span>入侵工具箱：你手上有这些武器</span></a></h3><p>除了上述要给大家拓展的，实际上我们能做的还有很多，比如：</p><ul><li><code>/proc/$PID/mem</code>: 可以直接读写某进程的内存（需要权限）</li><li>上文提到的gdb，它的<code>ptrace</code>: 调试神器，可以使用 <code>PTRACE_PEEKDATA</code> 和 <code>POKEDATA</code> 实现内存读写</li><li><code>process_vm_readv</code> 和 <code>process_vm_writev</code>: 高性能读写其他进程内存</li><li><code>pmap</code> + <code>cat /proc/$PID/maps</code>: 获取完整内存布局</li><li>Windows？可以看看 <a href="https://learn.microsoft.com/zh-cn/windows/win32/api/memoryapi/nf-memoryapi-readprocessmemory" target="_blank" rel="noopener noreferrer">ReadProcessMemory</a> 和 <a href="https://learn.microsoft.com/zh-cn/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory" target="_blank" rel="noopener noreferrer">WriteProcessMemory</a>，一样强大</li></ul><h2 id="拓展阅读与实战建议" tabindex="-1"><a class="header-anchor" href="#拓展阅读与实战建议"><span>拓展阅读与实战建议</span></a></h2><ol><li>写一个 Python 脚本演示 mmap 的懒分配与缺页异常</li><li>用 GDB 插件将 info registers + info proc mappings 输出为 Markdown 报表</li><li>在虚拟机内尝试 <code>ptrace</code> 注入代码，修改运行中程序的行为</li><li>看看 CIH 病毒的技术原理，理解固件篡改的真实危险</li><li>学习如何使用 <code>/proc</code> 文件系统模拟调试器行为</li></ol><s><!----></s><p> <a class="route-link" href="/posts/OSDesign/TheObjectOfTheOperatingSystem.html"><s>点我继续追番</s></a></p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated:: </span><time class="meta-item-info" datetime="2025-11-07T12:43:09.000Z" data-allow-mismatch>11/7/25, 8:43 PM</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: qwp20060309@outlook.com">qwp_p</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BPzQcCmO.js" defer></script>
  </body>
</html>
